
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Spatially Explicit Markov Methods &#8212; giddy  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="spatially-explicit-markov-methods">
<span id="sphx-glr-auto-examples-plot-markov-based-methods-py"></span><h1>Spatially Explicit Markov Methods<a class="headerlink" href="#spatially-explicit-markov-methods" title="Permalink to this headline">¶</a></h1>
<p>Introduction</p>
<blockquote>
<div><p>This notebook introduces Discrete Markov Chains (DMC) model and its two variants which explicitly incorporate spatial effects. We will demonstrate the usage of these methods by an empirical study for understanding [regional income dynamics in the US](#Regional-income-dynamics-in-the-US). The dataset is the per capita incomes observed annually from 1929 to 2009 for the lower 48 US states.</p>
<ul class="simple">
<li>[Classic Markov](#Classic-Markov)</li>
<li>[Spatial Markov](#Spatial-Markov)</li>
<li>[LISA Markov](#LISA-Markov)</li>
</ul>
<p>Note that a full execution of this notebook requires <strong>pandas</strong>, <strong>matplotlib</strong> and light-weight geovisualization package pysal-<strong>splot</strong>.</p>
</div></blockquote>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../_images/sphx_glr_plot_markov_based_methods_001.png"><img alt="../_images/sphx_glr_plot_markov_based_methods_001.png" src="../_images/sphx_glr_plot_markov_based_methods_001.png" style="width: 705.0px; height: 470.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../_images/sphx_glr_plot_markov_based_methods_002.png"><img alt="../_images/sphx_glr_plot_markov_based_methods_002.png" src="../_images/sphx_glr_plot_markov_based_methods_002.png" style="width: 705.0px; height: 329.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../_images/sphx_glr_plot_markov_based_methods_003.png"><img alt="../_images/sphx_glr_plot_markov_based_methods_003.png" src="../_images/sphx_glr_plot_markov_based_methods_003.png" style="width: 470.0px; height: 235.0px;" /></a>
</li>
</ul>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--------------------------------------------------------------</span>
                     <span class="n">Spatial</span> <span class="n">Markov</span> <span class="n">Test</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">classes</span><span class="p">:</span> <span class="mi">5</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">transitions</span><span class="p">:</span> <span class="mi">3840</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">regimes</span><span class="p">:</span> <span class="mi">5</span>
<span class="n">Regime</span> <span class="n">names</span><span class="p">:</span> <span class="n">LAG0</span><span class="p">,</span> <span class="n">LAG1</span><span class="p">,</span> <span class="n">LAG2</span><span class="p">,</span> <span class="n">LAG3</span><span class="p">,</span> <span class="n">LAG4</span>
<span class="o">--------------------------------------------------------------</span>
   <span class="n">Test</span>                   <span class="n">LR</span>                <span class="n">Chi</span><span class="o">-</span><span class="mi">2</span>
  <span class="n">Stat</span><span class="o">.</span>              <span class="mf">170.659</span>              <span class="mf">200.624</span>
    <span class="n">DOF</span>                   <span class="mi">60</span>                   <span class="mi">60</span>
<span class="n">p</span><span class="o">-</span><span class="n">value</span>                <span class="mf">0.000</span>                <span class="mf">0.000</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">H0</span><span class="p">)</span>           <span class="n">C0</span>         <span class="n">C1</span>         <span class="n">C2</span>         <span class="n">C3</span>         <span class="n">C4</span>
     <span class="n">C0</span>      <span class="mf">0.915</span>      <span class="mf">0.075</span>      <span class="mf">0.009</span>      <span class="mf">0.001</span>      <span class="mf">0.000</span>
     <span class="n">C1</span>      <span class="mf">0.066</span>      <span class="mf">0.827</span>      <span class="mf">0.105</span>      <span class="mf">0.001</span>      <span class="mf">0.001</span>
     <span class="n">C2</span>      <span class="mf">0.005</span>      <span class="mf">0.103</span>      <span class="mf">0.794</span>      <span class="mf">0.095</span>      <span class="mf">0.003</span>
     <span class="n">C3</span>      <span class="mf">0.000</span>      <span class="mf">0.009</span>      <span class="mf">0.094</span>      <span class="mf">0.849</span>      <span class="mf">0.048</span>
     <span class="n">C4</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.062</span>      <span class="mf">0.938</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">LAG0</span><span class="p">)</span>         <span class="n">C0</span>         <span class="n">C1</span>         <span class="n">C2</span>         <span class="n">C3</span>         <span class="n">C4</span>
     <span class="n">C0</span>      <span class="mf">0.963</span>      <span class="mf">0.030</span>      <span class="mf">0.006</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C1</span>      <span class="mf">0.060</span>      <span class="mf">0.832</span>      <span class="mf">0.107</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C2</span>      <span class="mf">0.000</span>      <span class="mf">0.140</span>      <span class="mf">0.740</span>      <span class="mf">0.120</span>      <span class="mf">0.000</span>
     <span class="n">C3</span>      <span class="mf">0.000</span>      <span class="mf">0.036</span>      <span class="mf">0.321</span>      <span class="mf">0.571</span>      <span class="mf">0.071</span>
     <span class="n">C4</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.167</span>      <span class="mf">0.833</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">LAG1</span><span class="p">)</span>         <span class="n">C0</span>         <span class="n">C1</span>         <span class="n">C2</span>         <span class="n">C3</span>         <span class="n">C4</span>
     <span class="n">C0</span>      <span class="mf">0.798</span>      <span class="mf">0.168</span>      <span class="mf">0.034</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C1</span>      <span class="mf">0.075</span>      <span class="mf">0.882</span>      <span class="mf">0.042</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C2</span>      <span class="mf">0.005</span>      <span class="mf">0.070</span>      <span class="mf">0.866</span>      <span class="mf">0.059</span>      <span class="mf">0.000</span>
     <span class="n">C3</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.064</span>      <span class="mf">0.902</span>      <span class="mf">0.034</span>
     <span class="n">C4</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.194</span>      <span class="mf">0.806</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">LAG2</span><span class="p">)</span>         <span class="n">C0</span>         <span class="n">C1</span>         <span class="n">C2</span>         <span class="n">C3</span>         <span class="n">C4</span>
     <span class="n">C0</span>      <span class="mf">0.847</span>      <span class="mf">0.153</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C1</span>      <span class="mf">0.081</span>      <span class="mf">0.789</span>      <span class="mf">0.129</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C2</span>      <span class="mf">0.005</span>      <span class="mf">0.098</span>      <span class="mf">0.793</span>      <span class="mf">0.098</span>      <span class="mf">0.005</span>
     <span class="n">C3</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.094</span>      <span class="mf">0.871</span>      <span class="mf">0.035</span>
     <span class="n">C4</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.102</span>      <span class="mf">0.898</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">LAG3</span><span class="p">)</span>         <span class="n">C0</span>         <span class="n">C1</span>         <span class="n">C2</span>         <span class="n">C3</span>         <span class="n">C4</span>
     <span class="n">C0</span>      <span class="mf">0.885</span>      <span class="mf">0.098</span>      <span class="mf">0.000</span>      <span class="mf">0.016</span>      <span class="mf">0.000</span>
     <span class="n">C1</span>      <span class="mf">0.039</span>      <span class="mf">0.814</span>      <span class="mf">0.140</span>      <span class="mf">0.000</span>      <span class="mf">0.008</span>
     <span class="n">C2</span>      <span class="mf">0.005</span>      <span class="mf">0.094</span>      <span class="mf">0.777</span>      <span class="mf">0.119</span>      <span class="mf">0.005</span>
     <span class="n">C3</span>      <span class="mf">0.000</span>      <span class="mf">0.023</span>      <span class="mf">0.129</span>      <span class="mf">0.754</span>      <span class="mf">0.094</span>
     <span class="n">C4</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.097</span>      <span class="mf">0.903</span>
<span class="o">--------------------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">LAG4</span><span class="p">)</span>         <span class="n">C0</span>         <span class="n">C1</span>         <span class="n">C2</span>         <span class="n">C3</span>         <span class="n">C4</span>
     <span class="n">C0</span>      <span class="mf">0.333</span>      <span class="mf">0.667</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>
     <span class="n">C1</span>      <span class="mf">0.048</span>      <span class="mf">0.774</span>      <span class="mf">0.161</span>      <span class="mf">0.016</span>      <span class="mf">0.000</span>
     <span class="n">C2</span>      <span class="mf">0.011</span>      <span class="mf">0.161</span>      <span class="mf">0.747</span>      <span class="mf">0.080</span>      <span class="mf">0.000</span>
     <span class="n">C3</span>      <span class="mf">0.000</span>      <span class="mf">0.010</span>      <span class="mf">0.062</span>      <span class="mf">0.896</span>      <span class="mf">0.031</span>
     <span class="n">C4</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.000</span>      <span class="mf">0.024</span>      <span class="mf">0.976</span>
<span class="o">--------------------------------------------------------------</span>
<span class="o">--------------------------------------------------</span>
             <span class="n">Markov</span> <span class="n">Homogeneity</span> <span class="n">Test</span>
<span class="o">--------------------------------------------------</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">classes</span><span class="p">:</span> <span class="mi">5</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">transitions</span><span class="p">:</span> <span class="mi">3840</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">regimes</span><span class="p">:</span> <span class="mi">5</span>
<span class="n">Regime</span> <span class="n">names</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<span class="o">--------------------------------------------------</span>
   <span class="n">Test</span>                   <span class="n">LR</span>                <span class="n">Chi</span><span class="o">-</span><span class="mi">2</span>
  <span class="n">Stat</span><span class="o">.</span>              <span class="mf">170.659</span>              <span class="mf">200.624</span>
    <span class="n">DOF</span>                   <span class="mi">60</span>                   <span class="mi">60</span>
<span class="n">p</span><span class="o">-</span><span class="n">value</span>                <span class="mf">0.000</span>                <span class="mf">0.000</span>
<span class="o">--------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="n">H0</span><span class="p">)</span>        <span class="mi">0</span>        <span class="mi">1</span>        <span class="mi">2</span>        <span class="mi">3</span>        <span class="mi">4</span>
    <span class="mi">0</span>    <span class="mf">0.915</span>    <span class="mf">0.075</span>    <span class="mf">0.009</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>
    <span class="mi">1</span>    <span class="mf">0.066</span>    <span class="mf">0.827</span>    <span class="mf">0.105</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>
    <span class="mi">2</span>    <span class="mf">0.005</span>    <span class="mf">0.103</span>    <span class="mf">0.794</span>    <span class="mf">0.095</span>    <span class="mf">0.003</span>
    <span class="mi">3</span>    <span class="mf">0.000</span>    <span class="mf">0.009</span>    <span class="mf">0.094</span>    <span class="mf">0.849</span>    <span class="mf">0.048</span>
    <span class="mi">4</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.062</span>    <span class="mf">0.938</span>
<span class="o">--------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>         <span class="mi">0</span>        <span class="mi">1</span>        <span class="mi">2</span>        <span class="mi">3</span>        <span class="mi">4</span>
    <span class="mi">0</span>    <span class="mf">0.963</span>    <span class="mf">0.030</span>    <span class="mf">0.006</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">1</span>    <span class="mf">0.060</span>    <span class="mf">0.832</span>    <span class="mf">0.107</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">2</span>    <span class="mf">0.000</span>    <span class="mf">0.140</span>    <span class="mf">0.740</span>    <span class="mf">0.120</span>    <span class="mf">0.000</span>
    <span class="mi">3</span>    <span class="mf">0.000</span>    <span class="mf">0.036</span>    <span class="mf">0.321</span>    <span class="mf">0.571</span>    <span class="mf">0.071</span>
    <span class="mi">4</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.167</span>    <span class="mf">0.833</span>
<span class="o">--------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>         <span class="mi">0</span>        <span class="mi">1</span>        <span class="mi">2</span>        <span class="mi">3</span>        <span class="mi">4</span>
    <span class="mi">0</span>    <span class="mf">0.798</span>    <span class="mf">0.168</span>    <span class="mf">0.034</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">1</span>    <span class="mf">0.075</span>    <span class="mf">0.882</span>    <span class="mf">0.042</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">2</span>    <span class="mf">0.005</span>    <span class="mf">0.070</span>    <span class="mf">0.866</span>    <span class="mf">0.059</span>    <span class="mf">0.000</span>
    <span class="mi">3</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.064</span>    <span class="mf">0.902</span>    <span class="mf">0.034</span>
    <span class="mi">4</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.194</span>    <span class="mf">0.806</span>
<span class="o">--------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>         <span class="mi">0</span>        <span class="mi">1</span>        <span class="mi">2</span>        <span class="mi">3</span>        <span class="mi">4</span>
    <span class="mi">0</span>    <span class="mf">0.847</span>    <span class="mf">0.153</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">1</span>    <span class="mf">0.081</span>    <span class="mf">0.789</span>    <span class="mf">0.129</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">2</span>    <span class="mf">0.005</span>    <span class="mf">0.098</span>    <span class="mf">0.793</span>    <span class="mf">0.098</span>    <span class="mf">0.005</span>
    <span class="mi">3</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.094</span>    <span class="mf">0.871</span>    <span class="mf">0.035</span>
    <span class="mi">4</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.102</span>    <span class="mf">0.898</span>
<span class="o">--------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="mi">0</span>        <span class="mi">1</span>        <span class="mi">2</span>        <span class="mi">3</span>        <span class="mi">4</span>
    <span class="mi">0</span>    <span class="mf">0.885</span>    <span class="mf">0.098</span>    <span class="mf">0.000</span>    <span class="mf">0.016</span>    <span class="mf">0.000</span>
    <span class="mi">1</span>    <span class="mf">0.039</span>    <span class="mf">0.814</span>    <span class="mf">0.140</span>    <span class="mf">0.000</span>    <span class="mf">0.008</span>
    <span class="mi">2</span>    <span class="mf">0.005</span>    <span class="mf">0.094</span>    <span class="mf">0.777</span>    <span class="mf">0.119</span>    <span class="mf">0.005</span>
    <span class="mi">3</span>    <span class="mf">0.000</span>    <span class="mf">0.023</span>    <span class="mf">0.129</span>    <span class="mf">0.754</span>    <span class="mf">0.094</span>
    <span class="mi">4</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.097</span>    <span class="mf">0.903</span>
<span class="o">--------------------------------------------------</span>
<span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>         <span class="mi">0</span>        <span class="mi">1</span>        <span class="mi">2</span>        <span class="mi">3</span>        <span class="mi">4</span>
    <span class="mi">0</span>    <span class="mf">0.333</span>    <span class="mf">0.667</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>
    <span class="mi">1</span>    <span class="mf">0.048</span>    <span class="mf">0.774</span>    <span class="mf">0.161</span>    <span class="mf">0.016</span>    <span class="mf">0.000</span>
    <span class="mi">2</span>    <span class="mf">0.011</span>    <span class="mf">0.161</span>    <span class="mf">0.747</span>    <span class="mf">0.080</span>    <span class="mf">0.000</span>
    <span class="mi">3</span>    <span class="mf">0.000</span>    <span class="mf">0.010</span>    <span class="mf">0.062</span>    <span class="mf">0.896</span>    <span class="mf">0.031</span>
    <span class="mi">4</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.024</span>    <span class="mf">0.976</span>
<span class="o">--------------------------------------------------</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>

<span class="c1"># # Spatially Explicit Markov Methods</span>
<span class="c1">#</span>
<span class="c1"># **Author: Serge Rey &lt;sjsrey@gmail.com&gt;, Wei Kang &lt;weikang9009@gmail.com&gt;**</span>

<span class="c1"># ## Introduction</span>
<span class="c1">#</span>
<span class="c1"># This notebook introduces Discrete Markov Chains (DMC) model and its two variants which explicitly incorporate spatial effects. We will demonstrate the usage of these methods by an empirical study for understanding [regional income dynamics in the US](#Regional-income-dynamics-in-the-US). The dataset is the per capita incomes observed annually from 1929 to 2009 for the lower 48 US states.</span>
<span class="c1">#</span>
<span class="c1"># * [Classic Markov](#Classic-Markov)</span>
<span class="c1"># * [Spatial Markov](#Spatial-Markov)</span>
<span class="c1"># * [LISA Markov](#LISA-Markov)</span>
<span class="c1">#</span>
<span class="c1"># Note that a full execution of this notebook requires **pandas**, **matplotlib** and light-weight geovisualization package pysal-**splot**.</span>

<span class="c1"># ### Classic Markov</span>
<span class="c1">#</span>
<span class="c1"># ```python</span>
<span class="c1"># giddy.markov.Markov(self, class_ids, classes=None)</span>
<span class="c1"># ```</span>
<span class="c1">#</span>
<span class="c1"># We start with a look at a simple example of classic DMC methods implemented in PySAL-giddy. A Markov chain may be in one of $k$ different states/classes at any point in time. These states are exhaustive and mutually exclusive. If one had a time series of remote sensing images used to develop land use classifications, then the states could be defined as the specific land use classes and interest would center on the transitions in and out of different classes for each pixel.</span>
<span class="c1">#</span>
<span class="c1"># For example, suppose there are 5 pixels, each of which takes on one of 3 states (a,b,c) at 3 consecutive periods:</span>

<span class="c1"># In[1]:</span>


<span class="kn">import</span> <span class="nn">giddy</span>
<span class="kn">import</span> <span class="nn">libpysal</span>
<span class="kn">import</span> <span class="nn">libpysal.io.geotable</span> <span class="kn">as</span> <span class="nn">pdio</span>
<span class="kn">import</span> <span class="nn">mapclassify.api</span> <span class="kn">as</span> <span class="nn">mc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">esda.moran</span> <span class="kn">import</span> <span class="n">Moran</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">rcParams</span>

<span class="kn">from</span> <span class="nn">splot</span> <span class="kn">import</span> <span class="n">mapping</span> <span class="k">as</span> <span class="n">maps</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">],[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">],[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">],[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">],[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]])</span>
<span class="n">c</span>


<span class="c1"># So the first pixel was in state ‘b’ in period 1, state ‘a’ in period 2, and state ‘c’ in period 3. Each pixel&#39;s trajectory (row) owns [Markov property](https://en.wikipedia.org/wiki/Markov_property), meaning that which state a pixel takes on today is only dependent on its immediate past.</span>
<span class="c1">#</span>
<span class="c1"># Let&#39;s suppose that all the 5 pixels are governed by the same transition dynamics rule. That is, each trajectory is a realization of a Discrete Markov Chain process. We could pool all the 5 trajectories from which to estimate a transition probability matrix. To do that, we utlize the **Markov** class in **giddy**:</span>

<span class="c1"># In[2]:</span>


<span class="n">m</span> <span class="o">=</span> <span class="n">giddy</span><span class="o">.</span><span class="n">markov</span><span class="o">.</span><span class="n">Markov</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">m</span>


<span class="c1"># In this way, we create a **Markov** instance - $m$. Its attribute $classes$ gives 3 unique classes these pixels can take on, which are &#39;a&#39;,&#39;b&#39; and &#39;c&#39;.</span>

<span class="c1"># In[3]:</span>


<span class="n">m</span><span class="o">.</span><span class="n">classes</span>


<span class="c1"># In[4]:</span>


<span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>


<span class="c1"># In addition to extracting the unique states as an attribute, our **Markov** instance will also have the attribute *trnasitions* which is a transition matrix counting the number of transitions from one state to another. Since there are 3 unique states, we will have a $(3,3)$ transtion matrix:</span>

<span class="c1"># In[5]:</span>


<span class="n">m</span><span class="o">.</span><span class="n">transitions</span>


<span class="c1"># The above transition matrix indicates that of the four pixels that began a transition interval in state ‘a’, 1 remained in that state, 2 transitioned to state ‘b’ and 1 transitioned to state ‘c’. Another attribute $p$ gives the transtion probability matrix which is the transition dynamics rule ubiquitous to all the 5 pixels across the 3 periods. The maximum likehood estimator for each element $p_{i,j}$ is shown below where $n_{i,j}$ is the number of transitions from state $i$ to state $j$ and $k$ is the number of states (here $k=3$):</span>
<span class="c1">#</span>
<span class="c1"># $$\hat{p}_{i,j} = \frac{n_{i,j}}{\sum_{q=1}^k n_{i,q} }$$</span>
<span class="c1">#</span>

<span class="c1"># In[6]:</span>


<span class="n">m</span><span class="o">.</span><span class="n">p</span>


<span class="c1"># This means that if any of the 5 pixels was in state &#39;c&#39;, the probability of staying at &#39;c&#39; or transitioning to any other states (&#39;a&#39;, &#39;b&#39;) in the next period is the same (0.333). If a pixel was in state &#39;b&#39;, there is a high possibility that it would take on state &#39;c&#39; in the next period because $\hat{p}_{2,3}=0.667$.</span>
<span class="c1">#</span>

<span class="c1"># This simple example illustrates the basic creation of a Markov instance, but the small sample size makes it unrealistic for the more advanced features of this approach. For a larger example, we will look at an application of Markov methods to understanding regional income dynamics in the US. Here we will load in data on per capita incomes observed annually from 1929 to 2010 for the lower 48 US states:</span>

<span class="c1"># #### Regional income dynamics in the US</span>
<span class="c1"># Firstly, we load in data on per capita incomes observed annually from 1929 to 2009 for the lower 48 US states. We use the example dataset in [**libpysal**](https://github.com/pysal/libpysal) which was downloaded from [US Bureau of Economic Analysis](https://www.bea.gov).</span>

<span class="c1"># In[7]:</span>


<span class="n">f</span> <span class="o">=</span> <span class="n">libpysal</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">libpysal</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;usjoin.csv&quot;</span><span class="p">))</span>
<span class="n">pci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1929</span><span class="p">,</span><span class="mi">2010</span><span class="p">)])</span>
<span class="n">pci</span><span class="o">.</span><span class="n">shape</span>


<span class="c1"># The first row of the array is the per capita incomes for the 48 US states for the year 1929:</span>

<span class="c1"># In[8]:</span>


<span class="n">pci</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>


<span class="c1"># In order to apply the classic Markov approach to this series, we first have to discretize the distribution by defining our classes. There are many ways to do this including quantiles classification scheme, equal interval classification scheme, Fisher Jenks classification scheme, etc. For a list of classification methods, please refer to the pysal package [**mapclassify**](https://github.com/pysal/mapclassify).</span>
<span class="c1">#</span>
<span class="c1"># Here we will use the quintiles for each annual income distribution to define the classes. It should be noted that using quintiles for the pooled income distribution to define the classes will result in a different interpretation of the income dynamics. Quintiles for each annual income distribution (the former) will reveal more of relative income dynamics while those for the pooled income distribution (the latter) will provide insights in absolute dynamics.</span>

<span class="c1"># In[9]:</span>


<span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1929</span><span class="p">,</span><span class="mi">2010</span><span class="p">)</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">))</span>
<span class="n">order1929</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pci</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="n">order2009</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pci</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
<span class="n">names1929</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">order1929</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">names2009</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">order2009</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">first_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">names</span><span class="p">[</span><span class="n">order1929</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="n">names</span><span class="p">[</span><span class="n">order2009</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span><span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">pci</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1915</span><span class="p">,</span><span class="mi">54530</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1159</span><span class="p">),</span> <span class="n">names1929</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2010.5</span><span class="p">,</span><span class="mi">54530</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1159</span><span class="p">),</span> <span class="n">names2009</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">54530</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$y_{i,t}$&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Years&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Absolute Dynamics&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>


<span class="c1"># In[10]:</span>


<span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1929</span><span class="p">,</span><span class="mi">2010</span><span class="p">)</span>
<span class="n">rpci</span><span class="o">=</span> <span class="p">(</span><span class="n">pci</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">pci</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">))</span>
<span class="n">order1929</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rpci</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="n">order2009</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rpci</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
<span class="n">names1929</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">order1929</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">names2009</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">order2009</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">first_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">names</span><span class="p">[</span><span class="n">order1929</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="n">names</span><span class="p">[</span><span class="n">order2009</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span><span class="mi">10</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">rpci</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1915</span><span class="p">,</span><span class="mf">1.91</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mf">0.041</span><span class="p">),</span> <span class="n">names1929</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2010.5</span><span class="p">,</span><span class="mf">1.91</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mf">0.041</span><span class="p">),</span> <span class="n">names2009</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.94</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$y_{i,t}/\bar{y}_t$&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Years&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Relative Dynamics&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>


<span class="c1"># In[11]:</span>


<span class="n">q5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mc</span><span class="o">.</span><span class="n">Quantiles</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">yb</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">pci</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">q5</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>


<span class="c1"># In[12]:</span>


<span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span>


<span class="c1"># A number of things need to be noted here. First, we are relying on the classification methods in [**mapclassify**](https://github.com/pysal/mapclassify) for defining our quintiles. The class *Quantiles* uses quintiles ($k=5$) as the default and will create an instance of this class that has multiple attributes, the one we are extracting in the first line is $yb$ - the class id for each observation. The second thing to note is the transpose operator which gets our resulting array $q5$ in the proper structure required for use of Markov. Thus we see that the first spatial unit (Alabama with an income of 323) fell in the first quintile in 1929, while the last unit (Wyoming with an income of 675) fell in the fourth quintile.</span>
<span class="c1">#</span>
<span class="c1"># So now we have a time series for each state of its quintile membership. For example, Colorado’s quintile time series is:</span>

<span class="c1"># In[13]:</span>


<span class="n">q5</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>


<span class="c1"># indicating that it has occupied the 3rd, 4th and 5th quintiles in the distribution at the first 3 periods. To summarize the transition dynamics for all units, we instantiate a Markov object:</span>

<span class="c1"># In[14]:</span>


<span class="n">m5</span> <span class="o">=</span> <span class="n">giddy</span><span class="o">.</span><span class="n">markov</span><span class="o">.</span><span class="n">Markov</span><span class="p">(</span><span class="n">q5</span><span class="p">)</span>


<span class="c1"># The number of transitions between any two quintile classes could be counted:</span>

<span class="c1"># In[15]:</span>


<span class="n">m5</span><span class="o">.</span><span class="n">transitions</span>


<span class="c1"># By assuming the first-order Markov property, time homogeneity, spatial homogeneity and spatial independence, a transition probability matrix could be estimated which holds for all the 48 US states across 1929-2010:</span>

<span class="c1"># In[16]:</span>


<span class="n">m5</span><span class="o">.</span><span class="n">p</span>


<span class="c1"># The fact that each of the 5 diagonal elements is larger than $0.78$ indicates a high stability of US regional income dynamics system.</span>

<span class="c1"># Another very important feature of DMC model is the steady state distribution $\pi$ (also called limiting distribution) defined as $\pi p = \pi$. The attribute $steady\_state$ gives $\pi$ as follows:</span>

<span class="c1"># In[17]:</span>


<span class="n">m5</span><span class="o">.</span><span class="n">steady_state</span>


<span class="c1"># If the distribution at $t$ is a steady state distribution as shown above, then any distribution afterwards is the same distribution.</span>

<span class="c1"># With the transition probability matrix in hand, we can estimate the first mean passage time which is the average number of steps to go from a state/class to another state for the first time:</span>

<span class="c1"># In[18]:</span>


<span class="n">giddy</span><span class="o">.</span><span class="n">ergodic</span><span class="o">.</span><span class="n">fmpt</span><span class="p">(</span><span class="n">m5</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>


<span class="c1"># Thus, for a state with income in the first quintile, it takes on average 11.5 years for it to first enter the second quintile, 29.6 to get to the third quintile, 53.4 years to enter the fourth, and 103.6 years to reach the richest quintile.</span>

<span class="c1"># #### Regional context and Moran&#39;s Is</span>

<span class="c1"># Thus far we have treated all the spatial units as independent to estimate the transition probabilities. This hides an implicit assumption: the movement of a spatial unit in the income distribution is independent of the movement of its neighbors or the position of the neighbors in the distribution. But what if spatial context matters??</span>
<span class="c1">#</span>
<span class="c1"># We could plot the choropleth maps of per capita incomes in US to get a first impression of the spatial distribution.</span>

<span class="c1"># In[19]:</span>


<span class="n">data_table</span> <span class="o">=</span> <span class="n">pdio</span><span class="o">.</span><span class="n">read_files</span><span class="p">(</span><span class="n">libpysal</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;us48.shp&#39;</span><span class="p">))</span>
<span class="n">income_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">libpysal</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;usjoin.csv&quot;</span><span class="p">))</span>
<span class="n">complete_table</span> <span class="o">=</span> <span class="n">data_table</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">income_table</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;STATE_NAME&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
<span class="n">complete_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>


<span class="c1"># In[20]:</span>


<span class="n">index_year</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1929</span><span class="p">,</span><span class="mi">2010</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">maps</span><span class="o">.</span><span class="n">geoplot</span><span class="p">(</span><span class="n">complete_table</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">index_year</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">j</span><span class="p">]),</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">classi</span><span class="o">=</span><span class="s2">&quot;Quantiles&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Per Capita Income </span><span class="si">%s</span><span class="s1"> Quintiles&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">index_year</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">j</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="c1"># It is quite obvious that the per capita incomes are not randomly distributed: we could spot clusters in the mid-south, south-east and north-east. Let&#39;s proceed to calculate Moran&#39;s I, a widely used measure of global spatial autocorrelation, to aid the visual interpretation.</span>

<span class="c1"># In[21]:</span>


<span class="n">w</span> <span class="o">=</span> <span class="n">libpysal</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">libpysal</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;states48.gal&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
<span class="n">mits</span> <span class="o">=</span> <span class="p">[</span><span class="n">Moran</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">pci</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">mi</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">mi</span><span class="o">.</span><span class="n">EI</span><span class="p">,</span> <span class="n">mi</span><span class="o">.</span><span class="n">seI_norm</span><span class="p">,</span> <span class="n">mi</span><span class="o">.</span><span class="n">sim</span><span class="p">[</span><span class="mi">974</span><span class="p">])</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">mits</span><span class="p">])</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1929</span><span class="p">,</span><span class="mi">2010</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Moran</span><span class="se">\&#39;</span><span class="s1">s I&#39;</span><span class="p">)</span>
<span class="c1">#plot(years, res[:,1], label=&#39;E[I]&#39;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1.96</span><span class="o">*</span><span class="n">res</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upper bound&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">1.96</span><span class="o">*</span><span class="n">res</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lower bound&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Global spatial autocorrelation for annual US per capita incomes&quot;</span><span class="p">,</span><span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">15</span><span class="p">})</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">1929</span><span class="p">,</span><span class="mi">2009</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># From the above figure we could observe that Moran&#39;s I value was always positive and significant for each year across 1929-2009. In other words, US regional income series are not independent of each other and regional context could be important in shaping the regional income dynamics. However, the classic Markov approach is silent on this issue.</span>
<span class="c1"># We turn to the spatially explict Markov methods - **Spatial Markov** and **LISA Markov** - for an explicit incorporation of space in understanding US regional income distribution dynamics.</span>

<span class="c1"># ### [Spatial Markov](http://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.2001.tb00444.x/full)</span>
<span class="c1">#</span>
<span class="c1"># ```python</span>
<span class="c1"># giddy.markov.Spatial_Markov(self, y, w, k=4, permutations=0, fixed=False, variable_name=None)</span>
<span class="c1"># ```</span>

<span class="c1"># Spatial Markov is an extension to class Markov allowing for a more comprehensive analysis of the spatial dimensions of the transitional dynamics (Rey, 2001). Here, whether the transition probabilities are dependent on regional context is investigated and quantified. Rather than estimating one transition probability matrix, spatial Markov requires estimation of $k$ transition probability matrices, each of which is conditional on the regional context at the preceding period. The regional context is usually formalized by spatial lag - the weighted average income level of neighbors:</span>
<span class="c1">#</span>
<span class="c1"># $$z_{r,t} = \sum_{s=1}^{n} w_{r,s} y_{s,t}$$</span>
<span class="c1">#</span>
<span class="c1"># where $W$ is the spatial weight matrix and $w_{r,s}$ represents the weight that spatial unit $s$ contributes to the local context of spatial unit $r$ at time period $t$.</span>

<span class="c1"># Similar to the construction of a **Markov** instance, we could create a **Spatial Markov** instance by utilizing the $Spatial\_Markov$ class in **giddy**. The only difference between the adoption of $Markov$ and $Spatial\_Markov$ class is that the latter accepts the original continuous income data while the former requires a pre-classification/discretization. In other words, here we do not need to apply the classification methods in [**mapclassify**](https://github.com/pysal/mapclassify) as we did earlier. In fact, the **Spatial Markov** class nested the quantile classification methods and all we need to do is set the desired number of classes $k$ when creating the $Spatial\_Markov$ instance. Here, we set $k=5$ (quintile classes) as before.</span>
<span class="c1">#</span>
<span class="c1"># Different from before, quintiles are defined for the pooled relative incomes (by standardizing by each period by the mean). This is achieved by setting the parameter $fixed$ as *True*.</span>

<span class="c1"># In[22]:</span>




<span class="c1"># In[23]:</span>


<span class="n">sm</span> <span class="o">=</span> <span class="n">giddy</span><span class="o">.</span><span class="n">markov</span><span class="o">.</span><span class="n">Spatial_Markov</span><span class="p">(</span><span class="n">rpci</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># spatial_markov instance o</span>


<span class="c1"># We can next examine the global transition probability matrix for relative incomes.</span>

<span class="c1"># In[24]:</span>


<span class="n">sm</span><span class="o">.</span><span class="n">p</span>


<span class="c1"># The Spatial Markov allows us to compare the global transition dynamics to those conditioned on regional context. More specifically, the transition dynamics are split across economies who have spatial lags in different quintiles at the preceding year. In our example we have 5 classes, so 5 different conditioned transition probability matrices are estimated - P(LAG0), P(LAG1), P(LAG2), P(LAG3), and P(LAG4).</span>

<span class="c1"># In[25]:</span>


<span class="n">sm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>


<span class="c1"># The probability of a poor state remaining poor is 0.963 if their neighbors are in the 1st quintile and 0.798 if their neighbors are in the 2nd quintile. The probability of a rich economy remaining rich is 0.977 if their neighbors are in the 5th quintile, but if their neighbors are in the 4th quintile this drops to 0.903.</span>
<span class="c1">#</span>
<span class="c1"># We can also explore the different steady state distributions implied by these different transition probabilities:</span>

<span class="c1"># In[26]:</span>


<span class="n">sm</span><span class="o">.</span><span class="n">S</span>


<span class="c1"># The long run distribution for states with poor (rich) neighbors has 0.435 (0.018) of the values in the first quintile, 0.263 (0.200) in the second quintile, 0.204 (0.190) in the third, 0.0684 (0.255) in the fourth and 0.029 (0.337) in the fifth quintile. And, finally the spatially conditional first mean passage times:</span>

<span class="c1"># In[27]:</span>


<span class="n">sm</span><span class="o">.</span><span class="n">F</span>


<span class="c1"># States in the first income quintile with neighbors in the first quintile return to the first quintile after 2.298 years, after leaving the first quintile. They enter the fourth quintile 80.810 years after leaving the first quintile, on average. Poor states within neighbors in the fourth quintile return to the first quintile, on average, after 12.88 years, and would enter the fourth quintile after 28.473 years.</span>

<span class="c1"># Tests for this conditional type of spatial dependence include Likelihood Ratio (LR) test and $\chi^2$ test (Bickenbach and Bode, 2003) as well as a test based on information theory (Kullback et al., 1962). For the first two tests, we could proceed as follows to acquire their statistics, DOF and p-value.</span>

<span class="c1"># In[28]:</span>


<span class="n">giddy</span><span class="o">.</span><span class="n">markov</span><span class="o">.</span><span class="n">Homogeneity_Results</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>


<span class="c1"># From the above summary table, we can observe that the observed LR test statistic is 170.659 and the observed $\chi^2$ test statistic is 200.624. Their p-values are 0.000, which leads to the rejection of the null hypothesis of conditional spatial independence.</span>
<span class="c1">#</span>
<span class="c1"># For the last (information theory-based) test, we call the function $kullback$. The result is consistent with LR and $\chi^2$ tests. As shown below, the observed test statistic is 230.03 and its p-value is 2.22e-16, leading to the rejection of the null.</span>

<span class="c1"># In[29]:</span>


<span class="n">giddy</span><span class="o">.</span><span class="n">markov</span><span class="o">.</span><span class="n">kullback</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<span class="c1"># ### LISA Markov</span>
<span class="c1">#</span>
<span class="c1"># ```python</span>
<span class="c1"># giddy.markov.LISA_Markov(self, y, w, permutations=0, significance_level=0.05, geoda_quads=False)</span>
<span class="c1"># ```</span>
<span class="c1">#</span>
<span class="c1"># The Spatial Markov conditions the transitions on the value of the spatial lag for an observation at the beginning of the transition period. An alternative approach to spatial dynamics is to consider the joint transitions of an observation and its spatial lag in the distribution. By exploiting the form of the static LISA and embedding it in a dynamic context we develop the LISA Markov in which the states of the chain are defined as the four quadrants in the Moran scatter plot, namely, HH(=1), LH(=2), LL(=3), HL(=4). Continuing on with our US example, the LISA transitions are:</span>

<span class="c1"># In[30]:</span>




<span class="c1"># In[31]:</span>


<span class="n">lm</span> <span class="o">=</span> <span class="n">giddy</span><span class="o">.</span><span class="n">markov</span><span class="o">.</span><span class="n">LISA_Markov</span><span class="p">(</span><span class="n">pci</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<span class="n">lm</span><span class="o">.</span><span class="n">classes</span>


<span class="c1"># The LISA transitions are:</span>

<span class="c1"># In[32]:</span>


<span class="n">lm</span><span class="o">.</span><span class="n">transitions</span>


<span class="c1"># and the estimated transition probability matrix is:</span>

<span class="c1"># In[33]:</span>


<span class="n">lm</span><span class="o">.</span><span class="n">p</span>


<span class="c1"># The diagonal elements indicate the staying probabilities and we see that there is greater mobility for observations in quadrants 2 (LH) and 4 (HL) than 1 (HH) and 3 (LL).</span>
<span class="c1">#</span>
<span class="c1"># The implied long run steady state distribution of the chain is:</span>

<span class="c1"># In[34]:</span>


<span class="n">lm</span><span class="o">.</span><span class="n">steady_state</span>


<span class="c1"># again reflecting the dominance of quadrants 1 and 3 (positive autocorrelation). The first mean passage time for the LISAs is:</span>

<span class="c1"># In[35]:</span>


<span class="n">giddy</span><span class="o">.</span><span class="n">ergodic</span><span class="o">.</span><span class="n">fmpt</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>


<span class="c1"># To test for dependence between the dynamics of the region and its neighbors, we turn to $\chi^2$ test of independence. Here, the $\chi^2$ statistic, its p-value and degrees of freedom can be obtained from the attribute $chi\_2$. As the p-value is 0.0, the null of independence is clearly rejected.</span>

<span class="c1"># In[36]:</span>


<span class="n">lm</span><span class="o">.</span><span class="n">chi_2</span>


<span class="c1"># ### Next steps</span>
<span class="c1">#</span>
<span class="c1"># * Simulation/prediction of Markov chain and spatial Markov chain</span>

<span class="c1"># ### References</span>
<span class="c1">#</span>
<span class="c1"># * Rey, S. J. 2001. “[Spatial Empirics for Economic Growth and Convergence](http://onlinelibrary.wiley.com/doi/10.1111/j.1538-4632.2001.tb00444.x/full).” Geographical Analysis 33 (3). Wiley Online Library: 195–214.</span>
<span class="c1"># * Bickenbach, F., and E. Bode. 2003. “[Evaluating the Markov Property in Studies of Economic Convergence](http://journals.sagepub.com/doi/abs/10.1177/0160017603253789?journalCode=irxa).” International Regional Science Review 26 (3): 363–92.</span>
<span class="c1"># * Kullback, S., M. Kupperman, and H. H. Ku. 1962. “[Tests for Contingency Tables and Markov Chains](https://www.jstor.org/stable/1266291?seq=1#page_scan_tab_contents).” Technometrics: A Journal of Statistics for the Physical, Chemical, and Engineering Sciences 4 (4). JSTOR: 573–608.</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 0 minutes  2.910 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_markov_based_methods.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_markov_based_methods.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_markov_based_methods.ipynb" download=""><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_markov_based_methods.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/auto_examples/plot_markov_based_methods.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, pysal developers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/auto_examples/plot_markov_based_methods.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>